{% extends 'base.html' %}

{% block head %}
    <title>{{ space.name }}</title>
{% endblock %}

{% block body %}
        <h1>{{ space.name }}
            {% if current_user.is_authenticated and current_user.id == space.user_id %}
                <form action="{{ url_for('delete_space', space_id=space.id) }}" method="POST" class="space-details-actions">
                    <input type="submit" value="Delete" class="btn btn-danger">
                </form>
            {% endif %}
        </h1>

        <a href="{{ url_for('community_page', space_id=space.id) }}" class="btn btn-info">Visit Community</a>

        <div class="space-details-carousel-container">
            {% if space.photos %}
                <div class="space-details-carousel">
                    {% for photo in space.photos.split(',') %}
                        <img src="{{ url_for('static', filename=photo) }}" alt="Photo of {{ space.name }}">
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="space-details-info">
            <h2>Details</h2>
            <p><strong>Address:</strong> {{ space.address }}</p>
            <p><strong>Description:</strong> {{ space.description }}</p>
            <p><strong>Created By:</strong> {{ space.user_name }}</p>
            <p><strong>Date Created:</strong> {{ space.date_created.strftime('%Y-%m-%d') }}</p>
        </div>

        <div class="space-details-ratings">
            <h2>Ratings</h2>
            {% if ratings %}
                {% for rating in ratings %}
                    <div class="rating-block">
                        <div class="rating-header">
                            <div><strong>Rating by:</strong> {{ rating.user_name }} | <strong>Date:</strong> {{ rating.date_created.strftime('%Y-%m-%d') }}</div>
                            <div>
                                {% if current_user.is_authenticated and current_user.id == rating.user_id %}
                                    <form action="{{ url_for('delete_rating', rating_id=rating.id) }}" method="post">
                                        <input type="submit" value="Delete Rating" class="btn btn-danger">
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                        <div class="rating-content">
                            <p><strong>Overall Average Rating:</strong>
                                <span class="stars">
                                    {% set total_rating = (rating.cleanliness + rating.facilities + rating.accessibility + rating.natural_diversity + rating.eco_friendly_practices + rating.safety_security + rating.recreational_opportunities + rating.community_engagement + rating.educational_value + rating.scenic_beauty) / 10 %}
                                    {% set full_stars = total_rating | int %}
                                    {% set half_star = (total_rating - full_stars) >= 0.5 %}
                                    {% set empty_stars = 5 - full_stars - half_star %}

                                    {% for _ in range(full_stars) %}
                                        &#9733; <!-- Filled star -->
                                    {% endfor %}
                                    {% if half_star %}
                                        &frac12; <!-- Half star -->
                                    {% endif %}
                                    {% for _ in range(empty_stars) %}
                                        &#9734; <!-- Empty star -->
                                    {% endfor %}
                                </span>
                            </p>
                            <div class="factor-cols">
                                <div class="factor-col-1">
                                    <ul class="rating-details">
                                        <li>Cleanliness:
                                            <span class="stars">
                                                {% for _ in range(rating.cleanliness) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.cleanliness) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Facilities:
                                            <span class="stars">
                                                {% for _ in range(rating.facilities) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.facilities) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Accessibility:
                                            <span class="stars">
                                                {% for _ in range(rating.accessibility) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.accessibility) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Natural Diversity:
                                            <span class="stars">
                                                {% for _ in range(rating.natural_diversity) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.natural_diversity) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Eco-friendly Practices:
                                            <span class="stars">
                                                {% for _ in range(rating.eco_friendly_practices) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.eco_friendly_practices) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="factor-col-2">
                                    <ul class="rating-details">
                                        <li>Safety & Security:
                                            <span class="stars">
                                                {% for _ in range(rating.safety_security) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.safety_security) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Recreational Opportunities:
                                            <span class="stars">
                                                {% for _ in range(rating.recreational_opportunities) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.recreational_opportunities) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Community Engagement:
                                            <span class="stars">
                                                {% for _ in range(rating.community_engagement) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.community_engagement) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Educational Value:
                                            <span class="stars">
                                                {% for _ in range(rating.educational_value) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.educational_value) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                        <li>Scenic Beauty:
                                            <span class="stars">
                                                {% for _ in range(rating.scenic_beauty) %}
                                                    &#9733; <!-- Filled star -->
                                                {% endfor %}
                                                {% for _ in range(5 - rating.scenic_beauty) %}
                                                    &#9734; <!-- Empty star -->
                                                {% endfor %}
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <hr>
                            <p>{{ rating.text }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No ratings available for this space.</p>
            {% endif %}
        </div>

        <div class="add-rating">
            <h2>Add Rating</h2>
            {% if current_user.is_authenticated %}
                <form action="{{ url_for('add_rating', space_id=space.id) }}" method="POST" class="rating-form">
                    {{ ratingform.hidden_tag() }}
                    <fieldset>
                        <legend>Rate the Space</legend>
                        <div class="rating-row">
                            <div class="rating-group">
                                <label>Cleanliness</label>
                                <div id="cleanliness-rating" class="star-rating"></div>
                                {{ ratingform.cleanliness(style='display: none;') }}
                            </div>
                            <div class="rating-group">
                                <label>Facilities</label>
                                <div id="facilities-rating" class="star-rating"></div>
                                {{ ratingform.facilities(style='display: none;') }}
                            </div>
                        </div>
                        <div class="rating-row">
                            <div class="rating-group">
                                <label>Accessibility</label>
                                <div id="accessibility-rating" class="star-rating"></div>
                                {{ ratingform.accessibility(style='display: none;') }}
                            </div>
                            <div class="rating-group">
                                <label>Natural Diversity</label>
                                <div id="natural_diversity-rating" class="star-rating"></div>
                                {{ ratingform.natural_diversity(style='display: none;') }}
                            </div>
                        </div>
                        <div class="rating-row">
                            <div class="rating-group">
                                <label>Eco-friendly Practices</label>
                                <div id="eco_friendly_practices-rating" class="star-rating"></div>
                                {{ ratingform.eco_friendly_practices(style='display: none;') }}
                            </div>
                            <div class="rating-group">
                                <label>Safety & Security</label>
                                <div id="safety_security-rating" class="star-rating"></div>
                                {{ ratingform.safety_security(style='display: none;') }}
                            </div>
                        </div>
                        <div class="rating-row">
                            <div class="rating-group">
                                <label>Recreational Opportunities</label>
                                <div id="recreational_opportunities-rating" class="star-rating"></div>
                                {{ ratingform.recreational_opportunities(style='display: none;') }}
                            </div>
                            <div class="rating-group">
                                <label>Community Engagement</label>
                                <div id="community_engagement-rating" class="star-rating"></div>
                                {{ ratingform.community_engagement(style='display: none;') }}
                            </div>
                        </div>
                        <div class="rating-row">
                            <div class="rating-group">
                                <label>Educational Value</label>
                                <div id="educational_value-rating" class="star-rating"></div>
                                {{ ratingform.educational_value(style='display: none;') }}
                            </div>
                            <div class="rating-group">
                                <label>Scenic Beauty</label>
                                <div id="scenic_beauty-rating" class="star-rating"></div>
                                {{ ratingform.scenic_beauty(style='display: none;') }}
                            </div>
                        </div>
                    </fieldset>
                    {{ ratingform.text.label }}
                     <textarea {{ ratingform.text }} ></textarea>
                    <br>
                    <button type="submit" class="btn">{{ ratingform.submit.label }}</button>
                </form>
            {% endif %}
        </div>

    <script>
        document.querySelectorAll('.star-rating').forEach((ratingDiv) => {
            let inputField = ratingDiv.nextElementSibling;
            for (let i = 0; i < 5; i++) {
                let star = document.createElement('span');
                star.innerHTML = '&#9734;'; // Empty star
                star.onclick = () => {
                    inputField.value = 5 - i;
                    updateStars(ratingDiv, i);
                };
                ratingDiv.appendChild(star);
            }
        });

        function updateStars(ratingDiv, upto) {
            let stars = ratingDiv.children;
            for (let i = stars.length - 1; i >= 0; i--) {
                stars[i].innerHTML = '&#9734;'; // Empty star
                stars[i].classList.remove('filled');
                if (i >= upto) {
                    stars[i].innerHTML = '&#9733;'; // Filled star
                    stars[i].classList.add('filled');
                }
            }
        }

        $(document).ready(function(){
            $('.space-details-carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                prevArrow: '<button type="button" class="slick-prev"></button>',
                nextArrow: '<button type="button" class="slick-next"></button>',
            });
        });
    </script>
{% endblock %}
